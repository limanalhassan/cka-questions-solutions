# =========================
# CKA LAB - QUESTION 3 (Horizontal Pod Autoscaler)
# =========================
QUESTION := Q3
NAMESPACE := autoscale
DEPLOY := apache-server
YAML := q3.yaml
SOLUTION := solution.yaml

# =========================
# Default workflow
# =========================
.PHONY: all
all: clean setup deploy
	@echo "\nâœ… $(QUESTION) environment ready."
	@echo "   Deployment '$(DEPLOY)' is running in namespace '$(NAMESPACE)'."
	@echo "   Create the HPA manually or run 'make solution' to apply the solution.\n"

# =========================
# Environment Setup
# =========================
.PHONY: setup
setup:
	@echo "\nðŸ”§ Setting up $(QUESTION) environment..."
	kubectl create ns $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	kubectl apply -f $(YAML)
	@echo "âœ… Environment setup complete.\n"

.PHONY: deploy
deploy:
	@echo "\nðŸš€ Waiting for $(DEPLOY) deployment..."
	kubectl -n $(NAMESPACE) rollout status deploy/$(DEPLOY)
	@echo "âœ… $(DEPLOY) deployment ready.\n"

# =========================
# Solution Application
# =========================
.PHONY: solution
solution:
	@echo "\nðŸš€ Applying HPA solution..."
	kubectl apply -f $(SOLUTION)
	@echo "\nâœ… HPA solution applied."
	@echo "\nðŸ” Checking HPA status..."
	kubectl -n $(NAMESPACE) get hpa $(DEPLOY)
	@echo "\nðŸ“Š HPA Details:"
	kubectl -n $(NAMESPACE) describe hpa $(DEPLOY)
	@echo "\nâœ… Solution applied successfully.\n"

# =========================
# Testing / Validation
# =========================
.PHONY: status
status:
	@echo "\nðŸ“Š $(QUESTION) Environment Summary:"
	@echo "\nNamespace:"
	kubectl get ns $(NAMESPACE)
	@echo "\nDeployment:"
	kubectl -n $(NAMESPACE) get deploy $(DEPLOY)
	@echo "\nPods:"
	kubectl -n $(NAMESPACE) get pods -l app=$(DEPLOY)
	@echo "\nHPA:"
	kubectl -n $(NAMESPACE) get hpa $(DEPLOY) 2>/dev/null || echo "   No HPA found. Run 'make solution' to create it."
	@echo "\nService:"
	kubectl -n $(NAMESPACE) get svc $(DEPLOY)

.PHONY: watch
watch:
	@echo "\nðŸ‘€ Watching HPA and Pods (Press Ctrl+C to stop)..."
	@echo "   HPA Status:"
	kubectl -n $(NAMESPACE) get hpa $(DEPLOY) -w &
	@echo "\n   Pod Status:"
	kubectl -n $(NAMESPACE) get pods -l app=$(DEPLOY) -w

# =========================
# Cleanup
# =========================
.PHONY: clean
clean:
	@echo "\nðŸ§¹ Cleaning up $(QUESTION) lab resources..."
	@echo "â†’ Deleting namespace $(NAMESPACE)..."
	-kubectl delete ns $(NAMESPACE) --ignore-not-found
	@echo "âœ… Cleanup completed for $(QUESTION).\n"

